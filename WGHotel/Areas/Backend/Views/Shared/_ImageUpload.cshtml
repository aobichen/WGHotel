<div class="row" id="image-upload">
    <input type="hidden" name="ImgKey" id="imgkey" value="@ViewBag.ImgKey" />
    <div class="panel panel-primary">
        <div class="panel-heading" style="background-color:#fff;border:none;">
            <button type="button" class="btn btn-default" id="btnUpload">
                上傳
            </button>
            <div style="width:0;height:0;overflow:hidden">
                <input type="file" name="file[]" id="file" multiple />
            </div>
        </div>
        <div class="panel-body" style="background-color:#fff;border:none;">
            <p id="message" style="display:none;">

            </p>
            <div class="row" id="image-panel">

            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    jQuery(function(){

        let btnupload = $('#btnUpload', '#image-upload');
        let file = $('#file','#image-upload');
        let imgPanel = $('#image-panel', '#image-upload');
        let key = $('#imgkey', '#image-upload').val();
        let maxSize = 4050000;
        var size = 0;
        btnupload.on('click', function () {
            size = 0;
            file.val("");
            file.trigger('click');
        });

        file.on('change', function (e) {        
            $('#message').html('').hide();
            filesUpload(this);
        });

        function format_float(num, pos)
        {
            var size = Math.pow(10, pos);
            return Math.round(num * size) / size;
        }
 
        function preview(input) {
       
            if (input.files && input.files[0]) {
                var files = input.files;
                $.each(files, function (index, file) {          
                    var reader = new FileReader();          
                    reader.onload = function (e) {               
                        let col = $('<div class="col-md-3"></div>');
                        let DeleteIcon = $('<i class="glyphicon glyphicon-remove remove"></i>');
                        let imageTemp = $('<img/>').attr('src', e.target.result).addClass('img-responsive');
                        col.append(imageTemp);
                        col.append(DeleteIcon);
                        imgPanel.append(col);                       
                    }
 
                    reader.readAsDataURL(file);
                });
            }
        }

        function filesUpload(file) {
            var files = file.files;
            var formData = new FormData();
            
            if (files.length > 0) {
                for (var i = 0, max = files.length; i < max; i++) {
                    
                    size += files[i].size;
                    formData.append("files" + i, files[i]);
                }

                if (size > maxSize) {
                    $('#message').html('上傳資料過大').show();
                    size = 0;
                    return false;
                }
            }

            formData.append("key", key);

            $.ajax({
                type: "POST",
                url: '/ImageUpload',
                data: formData,
                contentType: false,
                processData: false,
                success: function (xhr) {                   
                    preview(file);
                },
                error: function (xhr) {
                    $('#message').html('上傳資料過大').show();
                    console.log("ERROR");
                }
            });
            //file.val('');
        };
        

        $('#image-panel').delegate(".remove", "click", function () {
            var self = $(this);
            $.ajax({
                type: "POST",
                url: '/ImageDelete',
                data: {SessionKey : key},
                contentType: false,
                processData: false,
                success: function (xhr) {
                    preview(file);
                },
                error: function (xhr) {
                    $('#message').html('上傳資料過大').show();
                    console.log("ERROR");
                }
            });
        });

           
    })
    

</script>
