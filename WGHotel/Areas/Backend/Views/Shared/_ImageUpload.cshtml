<div class="row" id="image-upload">
    <input type="hidden" name="ImgKey" id="imgkey" value="@ViewBag.ImgKey" />
    <div class="panel panel-primary">
        <div class="panel-heading" style="background-color:#fff;border:none;">
            <button type="button" class="btn btn-default" id="btnUpload">
                上傳
            </button>
            <div style="width:0;height:0;overflow:hidden">
                <input type="file" name="file[]" id="file" multiple />
            </div>
        </div>
        <div class="panel-body" style="background-color:#fff;border:none;">
            <p id="message" style="display:none;">

            </p>
            <div class="row" id="image-panel">
                @if (Session[ViewBag.ImgKey] != null)
                {
                    var images = (List<WGHotel.Models.ImageViewModel>)Session[ViewBag.ImgKey];
                    foreach (var img in images)
                    {
                        var base64 = Convert.ToBase64String(img.Image);
                        var imgSrc = String.Format("data:image/gif;base64,{0}", base64);
                        <div class="col-md-3">
                            <img class="img-responsive" src="@imgSrc" />
                            <i class="glyphicon glyphicon-remove remove" data-name="@img.Name"></i>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    jQuery(function(){

        let btnupload = $('#btnUpload', '#image-upload');
        let file = $('#file','#image-upload');
        let imgPanel = $('#image-panel', '#image-upload');
        let key = $('#imgkey', '#image-upload').val();
        let maxSize = 4050000;
        var size = 0;
        btnupload.on('click', function () {
            size = 0;
            file.val("");
            file.trigger('click');
        });

        file.on('change', function (e) {        
            $('#message').html('').hide();
            filesUpload(this);
        });

        function format_float(num, pos)
        {
            var size = Math.pow(10, pos);
            return Math.round(num * size) / size;
        }
 
        function preview(input) {
       
            if (input.files && input.files[0]) {
                var files = input.files;
                $.each(files, function (index, file) {
                  
                    var reader = new FileReader();          
                    reader.onload = function (e) {               
                        let col = $('<div class="col-md-3 img-container"></div>');
                        let DeleteIcon = $('<i class="glyphicon glyphicon-remove remove"></i>');
                        
                        DeleteIcon.attr("data-name",file.name);
                        let imageTemp = $('<img/>').attr('src', e.target.result).addClass('img-responsive');
                        col.append(imageTemp);
                        col.append(DeleteIcon);
                        imgPanel.append(col);                       
                    }
 
                    reader.readAsDataURL(file);
                });
            }
        }

        function filesUpload(file) {
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            var model = {};
            console.log(file.files);
            let files = file.files;
            for (var i = 0, max = files.length; i < max; i++) {                    
                if (!files[i].type.match(/^image/)) { //去除非圖片檔
                    console.log('file ' + (i + 1) + ' is not an image');
                    continue;
                }

                let Myfile = files[i];
                var name = Myfile.name;
                var src = window.URL.createObjectURL(Myfile);
                var img = document.createElement("img");
                var image = new Image();
                image.onload = function () {

                    var width = 200;
                    var height = 100;
                    canvas.width = 200;
                    canvas.height = 100;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    //var image = new Image();
                    ctx.drawImage(image, 0, 0, width, height);
                    var dataurl = canvas.toDataURL("image/jpeg");
                    //去掉 dataurl 開頭的 data:image/png;base64,
                    var regex = new RegExp('^data:' + 'image/jpeg' + ';base64,');
                    var base64 = dataurl.replace(regex, '');
                   
                    model.image = base64;
                    model.name = name;
                    var myimg = $('<img>').attr('src', dataurl);
                    imgPanel.append(myimg);
                };
                
                //img.src = canvas.toDataURL("image/jpeg");
                image.src = src;
            }
            
            SelfPost(model);
            
        };
        

        var SelfPost = function (model) {
            console.log(model);
            $.ajax({
                type: "POST",
                url: '/ImageUpload1',
                data: { data: model },
                cache: false,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                //contentType: false,
                //processData: false,
                success: function (xhr) {
                    //preview(file);
                },
                error: function (xhr) {
                    $('#message').html('上傳資料過大').show();
                    console.log("ERROR");
                }
            });
        }


        $('#image-panel').delegate(".remove", "click", function () {
            var self = $(this);
            var name = self.attr("data-name");
            $.ajax({
                type: "POST",
                url: '/ImageDelete',
                data: {name:name,SessionKey : key},
              
                success: function (xhr) {
                    self.closest('.img-container').remove();
                },
                error: function (xhr) {
                    $('#message').html('上傳資料過大').show();
                    console.log("ERROR");
                }
            });
        });

           
    })
    

</script>
